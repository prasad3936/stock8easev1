{% extends 'base.html' %} {% block title %}All Purchases{% endblock %} {% block
content %}
<style>
  @media print {
    .print-button {
      display: none;
    }
  }
</style>

<div class="container mt-4 print">
  <a
    href="{{ url_for('dashboard.index') }}"
    class="btn btn-secondary print print-button"
    >‚Üê Back to Dashboard</a
  >
  <a
    href="{{ url_for('party.party_list') }}"
    class="print-button btn-info print btn mt-3"
    >View Party List</a
  >

  <h1>Purchase List</h1>

  <!-- User Details -->
  <div>
    <p><strong>Firm Name:</strong> {{ user.firm_name }}</p>
    <p><strong>Email:</strong> {{ user.email }}</p>
    <p><strong>Mobile:</strong> {{ user.mobile }}</p>
  </div>

  <!-- Purchase Form -->
  <form id="purchaseForm">
    <input type="hidden" name="selected_party_id" id="selected_party_id" />
    <input
      type="hidden"
      name="selected_party_mobile"
      id="selected_party_mobile"
    />

    <h2>Items (Low Stock / Expired)</h2>
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>Product Name</th>
          <th>Purchase Quantity</th>
        </tr>
      </thead>
      <tbody>
        {% for item_name in combined_items %}
        <tr>
          <td>{{ item_name }}</td>
          <td>
            <input
              type="number"
              name="purchase_qty_{{ item_name }}"
              min="1"
              class="form-control"
              placeholder="Qty"
            />
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="d-flex justify-content-between mt-3">
      <button
        type="button"
        class="btn btn-primary print-button"
        onclick="window.print();"
      >
        Print
      </button>
      <button
        type="submit"
        class="btn btn-success print-button"
        id="submitBtn"
        disabled
      >
        Submit Purchase
      </button>
    </div>
  </form>

  <!-- Additional Actions -->
  <!--
  <div class="mt-3">
    <button class="btn btn-warning print-button" onclick="addExpiredItems()">
      Add Expired Items
    </button>
  </div>
-->
  <!-- Searchable Party Select -->
  <label for="partySearch" class="mt-4 print-button">Search Party:</label>
  <select id="partySearch" style="width: 300px"></select>

  <!-- Party List with Delete -->
  <ul class="mt-3 print-button">
    {% for party in party_data %}
    <li>
      {{ party.party_name }} - {{ party.contact_details }}
      <form
        method="POST"
        action="{{ url_for('party.delete_party', party_id=party.id) }}"
        style="display: inline"
      >
        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
      </form>
    </li>
    {% endfor %}
  </ul>

  <!-- Select2 + jQuery -->
  <link
    href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    rel="stylesheet"
  />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    $(document).ready(function () {
      $("#partySearch").select2({
        placeholder: "Search for a party",
        containerCssClass: "print-button",
        ajax: {
          url: "{{ url_for('party.search_party') }}",
          dataType: "json",
          delay: 250,
          data: function (params) {
            return { q: params.term };
          },
          processResults: function (data) {
            return { results: data };
          },
          cache: true,
        },
      });

      $("#partySearch").on("select2:select", function (e) {
        const selectedId = e.params.data.id;
        const mobile = e.params.data.mobile.replace(/\D/g, "");
        $("#selected_party_id").val(selectedId);
        $("#selected_party_mobile").val(mobile);
        $("#submitBtn").prop("disabled", false);
      });
    });
    document
      .getElementById("purchaseForm")
      .addEventListener("submit", function (event) {
        event.preventDefault();

        const partyId = document.getElementById("selected_party_id").value;
        const mobile = document.getElementById("selected_party_mobile").value;
        const selectedPartyName =
          $("#partySearch").select2("data")[0]?.text || "N/A";

        if (!partyId || !mobile) {
          alert("Please select a party before submitting.");
          return;
        }

        const firm = "{{ user.firm_name }}";
        const email = "{{ user.email }}";
        const userMobile = "{{ user.mobile }}";
        const date = new Date();
        const formattedDate = date.toLocaleDateString("en-IN", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
        const formattedTime = date.toLocaleTimeString("en-IN", {
          hour: "2-digit",
          minute: "2-digit",
        });

        let items = [];
        let totalQty = 0;
        let estimatedCost = 0;

        const rows = document.querySelectorAll("tbody tr");
        rows.forEach((row, index) => {
          const product = row.cells[0].innerText.trim();
          const qty = parseInt(row.querySelector("input").value.trim());
          if (qty && qty > 0) {
            totalQty += qty;
            estimatedCost += qty * 10; // Replace with actual unit price if available
            items.push(`${index + 1}. ${product.padEnd(18)} | Qty: ${qty}`);
          }
        });

        if (items.length === 0) {
          alert("Please enter at least one purchase quantity.");
          return;
        }

        const referenceId = "PO-" + date.getTime().toString().slice(-6);

        const message =
          `üßæ *Purchase Order Summary*\n\n` +
          `üìå *Reference ID:* ${referenceId}\n` +
          `üìÖ *Date:* ${formattedDate} | ${formattedTime}\n\n` +
          `üë§ *Firm:* ${firm}\n` +
          `üìß *Email:* ${email}\n` +
          `üì± *Mobile:* ${userMobile}\n\n` +
          `üì¶ *Items Ordered:*\n` +
          `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
          items.join("\n") +
          `\n` +
          `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
          `üìä *Total Quantity:* ${totalQty}\n` +
          `üí∞ *Estimated Cost:* ‚Çπ${estimatedCost.toFixed(2)}\n\n` +
          `üîΩ *Recipient:* ${selectedPartyName}\n` +
          `üìç *Status:* Pending Confirmation\n\n` +
          `üôè Thank you for your continued partnership.\nPlease confirm receipt and expected delivery timeline.`;

        const encoded = encodeURIComponent(message);
        const whatsappURL = `https://wa.me/${mobile}?text=${encoded}`;

        // ‚úÖ Notify user to print manually
        alert(
          "Purchase submitted. You can now click the Print button to save this screen as PDF."
        );

        // ‚úÖ Open WhatsApp message
        window.open(whatsappURL, "_blank");
      });

    function addExpiredItems() {
      fetch("/add-expired", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.message === "Expired products added") {
            alert("Expired products added successfully.");
            window.location.reload();
          } else {
            alert("Error adding expired items.");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Failed to add expired items.");
        });
    }
  </script>
</div>
{% endblock %}
